{
  "info": {
    "name": "EMDR - Stripe Payment Integration (Auto-Save)",
    "description": "Complete Stripe payment integration with automatic response saving",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:5000/api/v1",
      "type": "string"
    },
    {
      "key": "token",
      "value": "",
      "type": "string"
    },
    {
      "key": "clientSecret",
      "value": "",
      "type": "string"
    },
    {
      "key": "paymentIntentId",
      "value": "",
      "type": "string"
    },
    {
      "key": "orderId",
      "value": "",
      "type": "string"
    },
    {
      "key": "providerId",
      "value": "",
      "type": "string"
    },
    {
      "key": "foodId1",
      "value": "",
      "type": "string"
    },
    {
      "key": "foodId2",
      "value": "",
      "type": "string"
    },
    {
      "key": "publishableKey",
      "value": "",
      "type": "string"
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Collection level pre-request script",
          "console.log('üöÄ Request:', pm.request.method, pm.request.url.toString());",
          "console.log('üìÖ Timestamp:', new Date().toISOString());"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Collection level test script",
          "pm.test('‚úÖ Response time is acceptable', function () {",
          "    pm.expect(pm.response.responseTime).to.be.below(5000);",
          "});",
          "",
          "pm.test('‚úÖ Response has correct format', function () {",
          "    pm.response.to.have.jsonBody();",
          "});",
          "",
          "console.log('üìä Response Status:', pm.response.code);",
          "console.log('‚è±Ô∏è Response Time:', pm.response.responseTime + 'ms');"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "0. Login (Get Token)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Auto-save token from login response",
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    ",
              "    if (response.success && response.data.token) {",
              "        pm.collectionVariables.set('token', response.data.token);",
              "        console.log('‚úÖ Token saved successfully');",
              "        console.log('üîë Token:', response.data.token.substring(0, 20) + '...');",
              "        ",
              "        // Save user info",
              "        if (response.data.user) {",
              "            console.log('üë§ User:', response.data.user.fullName);",
              "            console.log('üìß Email:', response.data.user.email);",
              "            console.log('üé≠ Role:', response.data.user.role);",
              "        }",
              "    }",
              "}",
              "",
              "pm.test('‚úÖ Login successful', function () {",
              "    pm.response.to.have.status(200);",
              "    const response = pm.response.json();",
              "    pm.expect(response.success).to.be.true;",
              "    pm.expect(response.data.token).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"customer@example.com\",\n  \"password\": \"password123\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/login",
          "host": ["{{baseUrl}}"],
          "path": ["auth", "login"]
        },
        "description": "Login to get authentication token. Token will be automatically saved."
      },
      "response": []
    },
    {
      "name": "1. Get Stripe Config",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Auto-save publishable key",
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    ",
              "    if (response.success && response.data.publishableKey) {",
              "        pm.collectionVariables.set('publishableKey', response.data.publishableKey);",
              "        console.log('‚úÖ Publishable key saved');",
              "        console.log('üîë Key:', response.data.publishableKey.substring(0, 20) + '...');",
              "    }",
              "}",
              "",
              "pm.test('‚úÖ Config retrieved successfully', function () {",
              "    pm.response.to.have.status(200);",
              "    const response = pm.response.json();",
              "    pm.expect(response.success).to.be.true;",
              "    pm.expect(response.data.publishableKey).to.exist;",
              "    pm.expect(response.data.publishableKey).to.include('pk_test_');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/stripe/config",
          "host": ["{{baseUrl}}"],
          "path": ["stripe", "config"]
        },
        "description": "Get Stripe publishable key. Key will be automatically saved."
      },
      "response": []
    },
    {
      "name": "2. Create Payment Intent",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Auto-save payment intent details",
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    ",
              "    if (response.success && response.data) {",
              "        // Save important values",
              "        pm.collectionVariables.set('clientSecret', response.data.clientSecret);",
              "        pm.collectionVariables.set('paymentIntentId', response.data.paymentIntentId);",
              "        ",
              "        console.log('‚úÖ Payment Intent created successfully');",
              "        console.log('üîë Client Secret:', response.data.clientSecret.substring(0, 30) + '...');",
              "        console.log('üÜî Payment Intent ID:', response.data.paymentIntentId);",
              "        console.log('üí∞ Amount:', '$' + response.data.amount.toFixed(2));",
              "        ",
              "        // Display breakdown",
              "        if (response.data.breakdown) {",
              "            const b = response.data.breakdown;",
              "            console.log('\\nüìä Price Breakdown:');",
              "            console.log('   Subtotal: $' + b.subtotal.toFixed(2));",
              "            console.log('   Platform Fee (' + (b.state === 'CA' ? '10%' : '7%') + '): $' + b.platformFee.toFixed(2));",
              "            console.log('   State Tax: $' + b.stateTax.toFixed(2));",
              "            console.log('   Total: $' + b.total.toFixed(2));",
              "            console.log('   Vendor Gets: $' + b.vendorAmount.toFixed(2));",
              "            console.log('   State: ' + b.state);",
              "        }",
              "    }",
              "}",
              "",
              "pm.test('‚úÖ Payment Intent created', function () {",
              "    pm.response.to.have.status(200);",
              "    const response = pm.response.json();",
              "    pm.expect(response.success).to.be.true;",
              "    pm.expect(response.data.clientSecret).to.exist;",
              "    pm.expect(response.data.paymentIntentId).to.exist;",
              "    pm.expect(response.data.amount).to.be.above(0);",
              "});",
              "",
              "pm.test('‚úÖ Breakdown is correct', function () {",
              "    const response = pm.response.json();",
              "    const b = response.data.breakdown;",
              "    pm.expect(b.subtotal).to.be.above(0);",
              "    pm.expect(b.total).to.equal(b.subtotal + b.platformFee + b.stateTax);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}",
            "type": "text"
          },
          {
            "key": "Content-Type",
            "value": "application/json",
            "type": "text"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"providerId\": \"65f1234567890abcdef12345\",\n  \"items\": [\n    {\n      \"foodId\": \"65f9876543210fedcba98765\",\n      \"quantity\": 2\n    },\n    {\n      \"foodId\": \"65f1111111111111111111111\",\n      \"quantity\": 1\n    }\n  ]\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/stripe/create-payment-intent",
          "host": ["{{baseUrl}}"],
          "path": ["stripe", "create-payment-intent"]
        },
        "description": "Create a Stripe PaymentIntent and get clientSecret for frontend payment confirmation"
      },
      "response": []
    },
    {
      "name": "3. Get Payment Status",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Auto-save order ID from payment status",
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    ",
              "    if (response.success && response.data) {",
              "        console.log('‚úÖ Payment Status retrieved');",
              "        console.log('üìä Status:', response.data.status);",
              "        console.log('üí∞ Amount:', '$' + response.data.amount.toFixed(2));",
              "        ",
              "        if (response.data.orderId) {",
              "            pm.collectionVariables.set('orderId', response.data.orderId);",
              "            console.log('üÜî Order ID:', response.data.orderId);",
              "            console.log('üì¶ Order Status:', response.data.orderStatus);",
              "            console.log('üí≥ Payment Status:', response.data.paymentStatus);",
              "        } else {",
              "            console.log('‚ö†Ô∏è Order not created yet (webhook pending)');",
              "        }",
              "    }",
              "}",
              "",
              "pm.test('‚úÖ Payment status retrieved', function () {",
              "    pm.response.to.have.status(200);",
              "    const response = pm.response.json();",
              "    pm.expect(response.success).to.be.true;",
              "    pm.expect(response.data.status).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/stripe/payment-status/{{paymentIntentId}}",
          "host": ["{{baseUrl}}"],
          "path": ["stripe", "payment-status", "{{paymentIntentId}}"]
        },
        "description": "Check payment status. Order ID will be automatically saved if available."
      },
      "response": []
    },
    {
      "name": "4. Get Order Details",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Display order details",
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    ",
              "    if (response.success && response.data) {",
              "        const order = response.data;",
              "        console.log('‚úÖ Order Details retrieved');",
              "        console.log('\\nüì¶ Order Information:');",
              "        console.log('   Order ID:', order.orderId);",
              "        console.log('   Status:', order.status);",
              "        console.log('   Payment Status:', order.paymentStatus);",
              "        console.log('   Payment Method:', order.paymentMethod);",
              "        console.log('\\nüí∞ Pricing:');",
              "        console.log('   Subtotal: $' + order.subtotal.toFixed(2));",
              "        console.log('   Platform Fee: $' + order.platformFee.toFixed(2));",
              "        console.log('   State Tax: $' + order.stateTax.toFixed(2));",
              "        console.log('   Total: $' + order.totalPrice.toFixed(2));",
              "        console.log('   Vendor Amount: $' + order.vendorAmount.toFixed(2));",
              "        console.log('\\nüìç Location:');",
              "        console.log('   State:', order.state);",
              "        console.log('\\nüîó Stripe:');",
              "        console.log('   Payment Intent ID:', order.stripePaymentIntentId);",
              "        console.log('\\nüìÖ Created:', new Date(order.createdAt).toLocaleString());",
              "    }",
              "}",
              "",
              "pm.test('‚úÖ Order retrieved successfully', function () {",
              "    pm.response.to.have.status(200);",
              "    const response = pm.response.json();",
              "    pm.expect(response.success).to.be.true;",
              "    pm.expect(response.data.orderId).to.exist;",
              "});",
              "",
              "pm.test('‚úÖ Order is paid', function () {",
              "    const response = pm.response.json();",
              "    pm.expect(response.data.paymentStatus).to.equal('paid');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/orders/{{orderId}}",
          "host": ["{{baseUrl}}"],
          "path": ["orders", "{{orderId}}"]
        },
        "description": "Get complete order details with all information"
      },
      "response": []
    },
    {
      "name": "5. Create Refund (Admin/Provider)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Display refund details",
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    ",
              "    if (response.success && response.data) {",
              "        console.log('‚úÖ Refund created successfully');",
              "        console.log('üÜî Refund ID:', response.data.refundId);",
              "        console.log('üí∞ Amount:', '$' + response.data.amount.toFixed(2));",
              "        console.log('üìä Status:', response.data.status);",
              "    }",
              "}",
              "",
              "pm.test('‚úÖ Refund created', function () {",
              "    pm.response.to.have.status(200);",
              "    const response = pm.response.json();",
              "    pm.expect(response.success).to.be.true;",
              "    pm.expect(response.data.refundId).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}",
            "type": "text"
          },
          {
            "key": "Content-Type",
            "value": "application/json",
            "type": "text"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"orderId\": \"{{orderId}}\",\n  \"reason\": \"Customer requested refund\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/stripe/refund",
          "host": ["{{baseUrl}}"],
          "path": ["stripe", "refund"]
        },
        "description": "Create a refund for a paid order (Admin/Provider only)"
      },
      "response": []
    },
    {
      "name": "5. Simulate Webhook (Test)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "stripe-signature",
            "value": "t=1234567890,v1=test_signature",
            "type": "text",
            "description": "This will fail signature verification - use Stripe CLI or dashboard to send real webhooks"
          },
          {
            "key": "Content-Type",
            "value": "application/json",
            "type": "text"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"id\": \"evt_test_webhook\",\n  \"type\": \"payment_intent.succeeded\",\n  \"data\": {\n    \"object\": {\n      \"id\": \"{{paymentIntentId}}\",\n      \"amount\": 4567,\n      \"status\": \"succeeded\",\n      \"metadata\": {\n        \"customerId\": \"65f1234567890abcdef12345\",\n        \"providerId\": \"65f9876543210fedcba98765\",\n        \"state\": \"CA\",\n        \"items\": \"[{\\\"foodId\\\":\\\"65f9876543210fedcba98765\\\",\\\"quantity\\\":2}]\"\n      }\n    }\n  }\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/stripe/webhook",
          "host": ["{{baseUrl}}"],
          "path": ["stripe", "webhook"]
        },
        "description": "‚ö†Ô∏è This is for reference only. Real webhooks must come from Stripe with valid signatures. Use Stripe CLI: `stripe trigger payment_intent.succeeded`"
      },
      "response": []
    },
    {
      "name": "Test Cards Reference",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "https://stripe.com/docs/testing#cards",
          "protocol": "https",
          "host": ["stripe", "com"],
          "path": ["docs", "testing"],
          "hash": "cards"
        },
        "description": "Stripe Test Cards:\n\n‚úÖ Success: 4242 4242 4242 4242\n‚ùå Decline: 4000 0000 0000 0002\nüîê 3D Secure: 4000 0025 0000 3155\nüí≥ Insufficient Funds: 4000 0000 0000 9995\n‚è±Ô∏è Slow: 4000 0000 0000 0259\n\nExpiry: Any future date (12/34)\nCVC: Any 3 digits (123)\nZIP: Any 5 digits (12345)"
      },
      "response": []
    }
  ]
}
